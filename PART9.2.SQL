/*
    ZAD 1
 */
ALTER TABLE PROJEKTY ADD (
    CONSTRAINT PK_PROJEKTY PRIMARY KEY(ID_PROJEKTU),
    CONSTRAINT UK_PROJEKTY UNIQUE(OPIS_PROJEKTU),
    CHECK(DATA_ZAKONCZENIA > DATA_ROZPOCZECIA),
    CHECK(FUNDUSZ >= 0)
) MODIFY (
    OPIS_PROJEKTU NOT NULL
);

SELECT K.CONSTRAINT_NAME, K.CONSTRAINT_TYPE, K.SEARCH_CONDITION, C.COLUMN_NAME
FROM USER_CONSTRAINTS K
INNER JOIN USER_CONS_COLUMNS C ON K.CONSTRAINT_NAME = C.CONSTRAINT_NAME
WHERE K.TABLE_NAME = 'PROJEKTY'
ORDER BY K.CONSTRAINT_NAME;

/*
    ZAD 2
    [23000][1] ORA-00001: naruszono więzy unikatowe (INF149232.UK_PROJEKTY)
 */
INSERT INTO PROJEKTY (OPIS_PROJEKTU, DATA_ROZPOCZECIA, DATA_ZAKONCZENIA, FUNDUSZ) VALUES
    ('Indeksy bitmapowe', DATE '2015-04-12', DATE '2016-08-30', 40000);

/*
    ZAD 3
 */
CREATE TABLE PRZYDZIALY (
    ID_PROJEKTU NUMBER(4) CONSTRAINT FK_PRZYDZIALY_01 REFERENCES PROJEKTY(ID_PROJEKTU) NOT NULL,
    NR_PRACOWNIKA NUMBER(6) CONSTRAINT FK_PRZYDZIALY_02 REFERENCES PRACOWNICY(ID_PRAC) NOT NULL,
    OD DATE DEFAULT CURRENT_DATE,
    DO DATE, CONSTRAINT CHK_PRZYDZIALY_DATY CHECK(DO > OD),
    STAWKA NUMBER(7, 2) CONSTRAINT CHK_PRZYDZIALY_STAWKA CHECK(STAWKA > 0),
    ROLA VARCHAR(20) CONSTRAINT CHK_PRZYDZIALY_ROLA CHECK(ROLA IN ('KIERUJĄCY', 'ANALITYK', 'PROGRAMISTA'))
);

/*
    ZAD 4
 */
INSERT INTO PRZYDZIALY (ID_PROJEKTU, NR_PRACOWNIKA, OD, DO, STAWKA, ROLA) VALUES
    ((SELECT ID_PROJEKTU FROM PROJEKTY WHERE OPIS_PROJEKTU = 'Indeksy bitmapowe'),
    170, DATE '1999-04-10', DATE '1999-05-10', 1000, 'KIERUJĄCY');
INSERT INTO PRZYDZIALY (ID_PROJEKTU, NR_PRACOWNIKA, OD, STAWKA, ROLA) VALUES
    ((SELECT ID_PROJEKTU FROM PROJEKTY WHERE OPIS_PROJEKTU = 'Indeksy bitmapowe'),
    140, DATE '2000-12-01', 1500, 'ANALITYK');
INSERT INTO PRZYDZIALY (ID_PROJEKTU, NR_PRACOWNIKA, OD, STAWKA, ROLA) VALUES
    ((SELECT ID_PROJEKTU FROM PROJEKTY WHERE OPIS_PROJEKTU = 'Sieci kręgosłupowe'),
    140, DATE '2015-09-14', 2500, 'KIERUJĄCY');
SELECT * FROM PRZYDZIALY;

/*
    ZAD 5
    [42000][1758] ORA-01758: aby dodać obowiązkową kolumnę (NOT NULL) tabela musi być pusta
 */
ALTER TABLE PRZYDZIALY ADD GODZINY NUMBER(4) CHECK(GODZINY <= 9999) NOT NULL;

/*
    ZAD 6
 */

ALTER TABLE PRZYDZIALY ADD GODZINY NUMBER(4);
UPDATE PRZYDZIALY SET GODZINY = 50 WHERE ID_PROJEKTU = ID_PROJEKTU;
ALTER TABLE PRZYDZIALY ADD (CHECK(GODZINY <= 9999)) MODIFY (GODZINY NOT NULL);
SELECT * FROM PRZYDZIALY;

/*
    ZAD 7
 */
ALTER TABLE PROJEKTY DISABLE CONSTRAINT UK_PROJEKTY;
SELECT CONSTRAINT_NAME, STATUS FROM USER_CONSTRAINTS WHERE CONSTRAINT_NAME = 'UK_PROJEKTY';

/*
    ZAD 8
 */

INSERT INTO PROJEKTY (OPIS_PROJEKTU, DATA_ROZPOCZECIA, DATA_ZAKONCZENIA, FUNDUSZ)
    VALUES ('Indeksy bitmapowe', DATE '2015-04-12', DATE '2016-09-30', 40000);
SELECT * FROM PROJEKTY;

/*
    ZAD 9
    [23000][2299] ORA-02299: nie można zweryfikować poprawności (INF149232.UK_PROJEKTY) - znaleziono zduplikowane klucze
 */
ALTER TABLE PROJEKTY ENABLE CONSTRAINT UK_PROJEKTY;

/*
    ZAD 10
    TAK
 */
UPDATE PROJEKTY SET OPIS_PROJEKTU = 'Inne indeksy' WHERE ID_PROJEKTU = 5;
ALTER TABLE PROJEKTY ENABLE CONSTRAINT UK_PROJEKTY;

/*
    ZAD 11
    [72000][1441] ORA-01441: nie można zmniejszyć długości kolumny, ponieważ niektóre wartości są zbyt duże
 */
ALTER TABLE PROJEKTY MODIFY OPIS_PROJEKTU VARCHAR(10);

/*
    ZAD 12
    [23000][2292] ORA-02292: naruszono więzy spójności (INF149232.FK_PRZYDZIALY_01) - znaleziono rekord podrzędny
 */
DELETE FROM PROJEKTY WHERE OPIS_PROJEKTU = 'Sieci kręgosłupowe';

/*
    ZAD 13
 */
ALTER TABLE PRZYDZIALY DROP CONSTRAINT FK_PRZYDZIALY_01;
ALTER TABLE PRZYDZIALY ADD CONSTRAINT FK_PRZYDZIALY_01 FOREIGN KEY(ID_PROJEKTU) REFERENCES PROJEKTY(ID_PROJEKTU) ON DELETE CASCADE;
DELETE FROM PROJEKTY WHERE OPIS_PROJEKTU = 'Sieci kręgosłupowe';
SELECT * FROM PROJEKTY;
SELECT * FROM PRZYDZIALY;

/*
    ZAD 14
 */
DROP TABLE PROJEKTY CASCADE CONSTRAINTS;

SELECT CONSTRAINT_NAME, CONSTRAINT_TYPE AS C, SEARCH_CONDITION
FROM USER_CONSTRAINTS
WHERE TABLE_NAME = 'PRZYDZIALY'
ORDER BY CONSTRAINT_NAME;

/*
  ZAD 15
*/
DROP TABLE PRZYDZIALY;
DROP TABLE PROJEKTY_KOPIA;
SELECT TABLE_NAME FROM USER_TABLES;
