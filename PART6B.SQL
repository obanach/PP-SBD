/*
    ZAD 1
 */
SELECT
    ID_ZESP,
    NAZWA,
    ADRES
FROM ZESPOLY Z WHERE NOT EXISTS (SELECT 'A' FROM PRACOWNICY WHERE ID_ZESP = Z.ID_ZESP);

/*
    ZAD 2
 */
SELECT
    NAZWISKO,
    PLACA_POD,
    ETAT
FROM PRACOWNICY P WHERE PLACA_POD > (SELECT AVG(PLACA_POD) FROM PRACOWNICY WHERE ETAT = P.ETAT)
ORDER BY PLACA_POD DESC;

/*
    ZAD 3
 */
SELECT
    NAZWISKO,
    PLACA_POD
FROM PRACOWNICY P WHERE PLACA_POD >= (SELECT 0.75*PLACA_POD FROM PRACOWNICY WHERE ID_PRAC = P.ID_SZEFA)
ORDER BY NAZWISKO;

/*
    ZAD 4
 */
SELECT
    NAZWISKO
FROM PRACOWNICY P WHERE P.ETAT = 'PROFESOR' AND NOT EXISTS (SELECT 'A' FROM PRACOWNICY WHERE (ID_SZEFA = P.ID_PRAC AND ETAT = 'STAZYSTA'));

/*
    ZAD 5
 */
SELECT NAZWA,P.SUMA AS MAKS_SUMA_PLAC FROM (SELECT ID_ZESP, SUM(PLACA_POD) AS SUMA FROM PRACOWNICY GROUP BY ID_ZESP) P JOIN (SELECT MAX(SUM(PLACA_POD)) AS SUMA FROM PRACOWNICY GROUP BY ID_ZESP) Z ON P.SUMA=Z.SUMA JOIN ZESPOLY USING(ID_ZESP);

/*
    ZAD 6
 */
SELECT
    NAZWISKO,
    PLACA_POD
FROM PRACOWNICY P
WHERE (SELECT COUNT(PLACA_POD) FROM PRACOWNICY WHERE PLACA_POD > P.PLACA_POD) <  3;

/*
    ZAD 7
 */
SELECT
    EXTRACT(YEAR FROM(ZATRUDNIONY)) AS ROK,
    COUNT(NAZWISKO) AS LICZBA
FROM PRACOWNICY
GROUP BY EXTRACT(YEAR FROM(ZATRUDNIONY))
ORDER BY LICZBA DESC;

/*
    ZAD 8
 */
select
    extract(year from zatrudniony) as rok,
    count(nazwisko) as liczba
from pracownicy p group by extract(year from zatrudniony) having count(nazwisko) = (select max(count(nazwisko)) as liczba from pracownicy p group by extract(year from zatrudniony)) order by liczba desc;


/*
    ZAD 9.1
 */
SELECT 
    NAZWISKO, 
    PLACA_POD, 
    PLACA_POD - SREDNIA AS ROZNICA 
FROM (SELECT ID_ZESP, AVG(PLACA_POD) AS SREDNIA FROM PRACOWNICY GROUP BY ID_ZESP) Z JOIN PRACOWNICY USING (ID_ZESP) 
ORDER BY NAZWISKO;

/*
    ZAD 9.2
 */
SELECT 
    NAZWISKO, 
    PLACA_POD, 
    PLACA_POD - (SELECT AVG(PLACA_POD) FROM PRACOWNICY WHERE ID_ZESP = P.ID_ZESP) AS ROZNICA 
FROM PRACOWNICY P ORDER BY NAZWISKO;

/*
    ZAD 10.1
 */
SELECT 
    NAZWISKO, 
    PLACA_POD, 
    PLACA_POD - (SELECT AVG(PLACA_POD) FROM PRACOWNICY WHERE ID_ZESP = P.ID_ZESP) AS ROZNICA 
FROM PRACOWNICY P WHERE PLACA_POD - (SELECT AVG(PLACA_POD) FROM PRACOWNICY WHERE ID_ZESP = P.ID_ZESP) > 0 ORDER BY NAZWISKO;

/*
    ZAD 10.2
 */
SELECT 
    NAZWISKO, 
    PLACA_POD, 
    PLACA_POD - SREDNIA AS ROZNICA 
FROM ((SELECT ID_ZESP, AVG(PLACA_POD) AS SREDNIA FROM PRACOWNICY GROUP BY ID_ZESP) Z JOIN PRACOWNICY USING (ID_ZESP)) 
WHERE PLACA_POD - SREDNIA > 0 
ORDER BY NAZWISKO;

/*
    ZAD 11
 */
SELECT 
    P.NAZWISKO, 
    (SELECT COUNT(NAZWISKO) FROM PRACOWNICY WHERE P.ID_PRAC = ID_SZEFA) AS PODWLADNI 
FROM PRACOWNICY P JOIN ZESPOLY Z ON P.ID_ZESP = Z.ID_ZESP 
WHERE ETAT = 'PROFESOR' AND ADRES = 'PIOTROWO 3A';

/*
    ZAD 12
 */
SELECT NAZWA, SREDNIA_W_ZESPOLE, SREDNIA_OGOLNA, 
       CASE WHEN SREDNIA_W_ZESPOLE > SREDNIA_OGOLNA THEN ':)'
            WHEN SREDNIA_W_ZESPOLE < SREDNIA_OGOLNA THEN ':('
            ELSE '???' END AS NASTROJE
FROM (SELECT NAZWA, AVG(PLACA_POD) AS SREDNIA_W_ZESPOLE, ROUND((SELECT AVG(PLACA_POD) FROM PRACOWNICY),2) AS SREDNIA_OGOLNA FROM ZESPOLY LEFT JOIN PRACOWNICY USING(ID_ZESP) GROUP BY NAZWA);

/*
    ZAD 13
 */
SELECT * 
FROM ETATY E 
ORDER BY (SELECT COUNT(NAZWISKO) FROM PRACOWNICY WHERE E.NAZWA = ETAT) DESC, NAZWA;
